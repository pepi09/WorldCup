<!DOCTYPE html>
<html>
<head>

	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<title>World Cup 2014</title>

	<script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
	<script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
	<script type="text/javascript" src="bower_components/bootstrap/js/tooltip.js"></script>
	<script type="text/javascript" src="bower_components/handlebars/handlebars.js"></script>
	<script type="text/javascript" src="bower_components/moment/moment.js"></script>

	<link href="bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">

	<link rel="stylesheet" type="text/css" href="style.css">	
</head>
<body>


<div class="container">
      <div class="header">
        <ul class="nav nav-pills pull-right">
          <li class="active"><a href="#">Home</a></li>
        </ul>
        <h3 class="text-muted">Hack Bulgaria World Cup</h3>
      </div>

      <hr>

<div id="body">

</div>



<!-- template -->
<script id="entry-template" type="text/x-handlebars-template">
<div class="jumbotron">

<div class="progress progress-striped">
  <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 60%">
  </div>
</div>

<div>
{{ match_progress }}
</div>

<div class="minutes text-center"> {{ start_time }}</div>


<div class="flags text-center">
	<div class="pull-left">
	{{ home_team }}

	<img src="flags/{{ home_flag }}.png" class="flag_image" data-container="body" data-toggle="popover" data-title="{{ home_team }}" data-trigger="hover" data-placement="left" data-content="{{ home_team_info }}">
	{{ home_goals }}

	</div>
    <div class="pull-right">
	{{ away_goals }}
	<img src="flags/{{ away_flag }}.png" class="flag_image" data-container="body" data-toggle="popover" data-title="{{ away_team }}" data-trigger="hover" data-placement="right" data-content="{{ away_team_info }}">
	{{ away_team }}
	</div>
</div>

</div>
</script>


<script type="text/javascript">

var get_today_matches = function( cb ){

	var today_matches = [],
		code = "",
		home_team_info = "",
		away_team_info = "";

	var team_info_generator = function(info){
		return info.country+" is in "+info.group_letter+" group. With "+info.wins+" wins, "+info.losses+" losses and "+info.games_played+" games played."; 
	}

$.when( $.getJSON("http://worldcup.sfg.io/matches/today"), $.getJSON("http://worldcup.sfg.io/teams/results") )
	.done(function(matches, results) {

matches[0].forEach(function(element, index){
	results[0].forEach(function(element1){
		
		if(element1.fifa_code === element.home_team.code){
			home_team_info = team_info_generator(element1);
		}
		if(element1.fifa_code === element.away_team.code){
			away_team_info = team_info_generator(element1);
		}
	});


today_matches[index] = {
	home_team: element.home_team.country,
	away_team: element.away_team.country,
	home_goals: element.home_team.goals,
	away_goals: element.away_team.goals,
	home_flag: element.home_team.code,
	away_flag: element.away_team.code,
	time: element.datetime,
	status: element.status,
	home_team_info: home_team_info,
	away_team_info: away_team_info
}
});
cb(today_matches);
});
}


get_today_matches(function(matches){

console.log(matches);


matches.forEach(function(match){
    if (match["status"] === "future"){


    var start_time = "Match starts at: 13:00h"

    var source   = $("#entry-template").html();
	var template = Handlebars.compile(source);
	var context = {
        home_team: match["home_team"],
        away_team: match["away_team"],
        home_goals: match["home_goals"],
        away_goals: match["away_goals"],
        home_flag: match["home_flag"],
        away_flag: match["away_flag"],
        home_team_info: match["home_team_info"],
        away_team_info: match["away_team_info"],
        start_time : start_time,
    }
	var html    = template(context);
	$("#body").append(html);
}
else {
    today = new Date();
    today = today.toJSON();
    var now = Date.parse(today);

    var match_time = Date.parse(match["datetime"]);
    // console.log(match_time);
    var end_time = (match_time + 5400000) - now;
    // console.log(end_time);


    var homeTeam = match["home_team"];
    var awayTeam = match["away_team"];

    var source   = $("#entry-template").html();
    var template = Handlebars.compile(source);
    var context = {
        home_team: homeTeam["country"],
        away_team: awayTeam["country"],
        home_goals: homeTeam["goals"],
        away_goals: awayTeam["goals"],
        home_flag: homeTeam["code"],
        away_flag: awayTeam["code"],
        match_progress : end_time,

    }
    var html    = template(context);
    $("#body").append(html);
}
	$('.flag_image').popover();

});
});

</script>


<div class="footer">
	<p>Â© 2014</p>
</div>

</div>

</body>
</html>